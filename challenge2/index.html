<!doctype html>
<html>
  <head>
    <title>Gnest Challenge 1</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
    </style>
  </head>
  <body>
    <div ng-app="myApp" ng-controller="pageCtrl">
		<nav class="navbar navbar-default">
			<div class="navbar-header" style="margin-left: 20px; color: steelblue;">
				<h2>Gnest Thermostat Viewer</h2>
			</div>
		</nav>
		<div class="container-fluid">
			<div class="panel panel-default">
				<div class="panel-heading" style='font-family="Open Sans", sans-serif; font-weight: 900;'>
					Summary
				</div>
				<div class="panel-body">
					<p>Number of thermostats reading: {{data.num}}</p>
					<p>Average Temperature: {{data.average}} °C</p>
				</div>
			</div>
			
			<div class="panel panel-default">
				<div class="panel-heading">
					Historical
				</div>
				<div class="panel-body">
					<div class="container-fluid">
						<label>Start Date/Time</label>
						<br />
						<div class="row" style="display: inline-block;">
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<input ng-model="data.startDate" type='date' class="form-control" />
							</div>
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<input ng-model="data.startTime" type='text' class="form-control" placeholder="00:00"/>
							</div>
						</div>
						<br />
						<label>End Date/Time</label>
						<br />
						<div class="row" style="display: inline-block;">
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<input ng-model="data.endDate" type='date' class="form-control" />
							</div>
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<input ng-model="data.endTime" type='text' class="form-control" placeholder="00:00"/>
							</div>
						</div>
						<br />
						<button class="btn btn-primary" ng-click="getHistorics()">Display Data</button>
	
						<p id="graph"></p>
					</div>
				</div>
			</div>
			<button class="btn btn-primary" ng-click="data.pause=!data.pause">Pause</button>
		</div>
	</div>

<script>
	var app = angular.module("myApp", []);

	app.controller("pageCtrl", ['$scope', '$interval', function($scope, $interval) {
		$scope.data = {};
		$scope.data.temps = [123123];
		$scope.data.num = 0;
		$scope.data.average = 0;
		$scope.data.cd = 0;
		$scope.data.pause=false;
		
		$scope.interpolate = function(data, x, y, res) {
			
		}
		
		$scope.getHistorics = function() {
			$.ajax({
				type: "GET",
				url: "/hist_temps",
				data: {startDate: $scope.data.startDate,
						startTime: $scope.data.startTime, 
						endDate: $scope.data.endDate, 
						endTime: $scope.data.endTime },
				dataType: 'json',
				success: function(res) {
				}
			});
		}
		
		$scope.updateCurrent = function() {
			$.ajax({
				type: "GET",
				url: "/current",
				data: {},
				dataType: 'json',
				success: function(res) {
					console.log(res);
					var avg = 0;
					var count = 0;
					var alive = [];
					for(var i = 0; i < res.length; i++) {
						if(new Date(2017,8,28,15,17,0) - new Date(res[i].timestamp) > 1000 * 60) {
							console.log(new Date(2017,9,28,19,17,0) - new Date(res[i].timestamp));
							console.log((new Date(2017,9,28,19,17,0)));
							console.log((new Date(res[i].timestamp)));
						}
						else {
							console.log("Added");
							alive.push(res[i]);
						}
					}
					
					for(var i = 0; i < alive.length; i++) {
						avg += alive[i].temp;
					}
					if(alive.length == 0)
						return
					avg /= alive.length;
					$scope.data.average = avg;
					$scope.data.num = alive.length;
					$scope.$apply();
				}
			});
		}
		
		$scope.update = function() {
			if($scope.data.pause)
				return
			$.ajax({
				type: "GET",
				url: "/temps",
				data: {},
				dataType: 'json',
				jsonpCallback: "callback",
				success: function(result) {
				for(var i = 0; i < result.length; i++) {
					for(var j = 0; j < result[i].length; j++) {
						result[i][j] = parseFloat(result[i][j]);
					}
				}
					$scope.data.temps = result;
					$scope.data.num = $scope.data.temps.length;
					$scope.data.average = 0;
					var count = 0;
					for(var i = 0; i < result.length; i++) {
						if(result[i].length > 0) {
							$scope.data.average += parseFloat(result[i][result[i].length - 1]);
							count++;
						}
					}
					$scope.data.average /= count;
					console.log("HI2");
					
					if($scope.data.cd == 0) {
						var dat = [];
					    for(var i = 0; i < result.length; i++) {				
							dat.push({values: result[i].map(function(x, i){return {x: i, y: x}}), key:"Thermostat" + i});
						}
					    var myData = dat;
							  
						nv.addGraph(function() {
							  var chart = nv.models.lineWithFocusChart()
											.margin({left: 100})  //Adjust chart margins to give the x-axis some breathing room.
											.useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!
											.showLegend(true)       //Show the legend, allowing users to turn on/off line series.
											.showYAxis(true)        //Show the y-axis
											.showXAxis(true)        //Show the x-axis
							  ;

							  chart.xAxis     //Chart x-axis settings
								  .axisLabel('Time since on (seconds)')
								  .tickFormat(d3.format(',r'));

							  chart.yAxis     //Chart y-axis settings
								  .axisLabel('Temperature (°C)')
								  .tickFormat(d3.format('.02f'));

							  /* Done setting the chart up? Time to render it!*/
							
								d3.select("#graph").selectAll("svg").remove();
							  $scope.data.cv = d3.select('#graph').append("svg").attr("height", 400)    //Select the <svg> element you want to render the chart in.   
								  .datum(myData)         //Populate the <svg> element with chart data...
								  .call(chart);          //Finally, render the chart!

							  //Update the chart when window resizes.
							  nv.utils.windowResize(function() { chart.update() });
							  return chart;
							});
					}
					else {
						$scope.data.cd.datum(myData);
					}
					
					$scope.$apply();
				},
				failure: function(err) {
					console.log("Failed");
				}
			})
		}
		$scope.updateCurrent();
		$interval($scope.updateCurrent, 2000);
	}]);
</script>
  </body>
</html>
